# HAL Contract v2 — Specification

**Version:** 2.0
**Status:** Stable
**Date:** 2026-02-20

## 1. Introduction

The HAL Contract defines a vendor-neutral interface for interacting with quantum backends. Any backend — simulator, cloud QPU, or HPC cluster — implements the `Backend` trait to participate in orchestrated quantum-HPC workflows.

The contract is intentionally minimal: it covers the job lifecycle and nothing more. Authentication, plugin discovery, and backend configuration are implementation concerns outside the spec.

## 2. Design Principles

1. **Async-native** — All I/O methods are async. Backends may perform network calls, queue submissions, or hardware interactions.
2. **Thread-safe** — The `Send + Sync` bound enables shared ownership via `Arc<dyn Backend>`. Schedulers and orchestrators rely on this.
3. **Minimal** — Only the methods needed for the job lifecycle. No configuration, no plugin discovery, no authentication.
4. **Infallible introspection** — `capabilities()` is synchronous and infallible. A backend that cannot report capabilities without I/O is not correctly initialized.
5. **Circuit-generic** — The trait is parameterized over a circuit type `C`, making it independent of any specific intermediate representation.

## 3. Backend Trait

### 3.1 Lifecycle

```text
  capabilities() ──→ validate() ──→ submit() ──→ status() ──→ result()
   (sync, &ref)       (async)       (async)      (async)      (async)
```

### 3.2 Method Table

| Method | Kind | Required | Returns | Notes |
|--------|------|----------|---------|-------|
| `name()` | sync | yes | `&str` | Human-readable backend identifier |
| `capabilities()` | sync | yes | `&Capabilities` | Cached at construction time |
| `availability()` | async | yes | `HalResult<BackendAvailability>` | Lightweight liveness check |
| `validate()` | async | yes | `HalResult<ValidationResult>` | Three-state: Valid / Invalid / RequiresTranspilation |
| `submit()` | async | yes | `HalResult<JobId>` | Job MUST start in `Queued` status |
| `status()` | async | yes | `HalResult<JobStatus>` | Returns current job state |
| `result()` | async | yes | `HalResult<ExecutionResult>` | Only valid when status is `Completed` |
| `cancel()` | async | yes | `HalResult<()>` | Best-effort cancellation |
| `wait()` | async | provided | `HalResult<ExecutionResult>` | Default: 500ms poll, 5min timeout |

### 3.3 Contract Rules

1. `capabilities()` MUST be synchronous and infallible. Capabilities MUST be cached at construction time.
2. `availability()` SHOULD perform a lightweight liveness check (e.g., HTTP ping, queue depth query).
3. `validate()` MUST check the circuit against backend constraints before submission. It SHOULD check at minimum: qubit count vs `capabilities().num_qubits` and gate support vs `capabilities().gate_set`.
4. `submit()` MUST return a `JobId` with initial status `Queued`.
5. `result()` MUST only be called when `status()` returns `Completed`. Calling it in any other state is undefined behavior.
6. `wait()` has a default implementation that polls `status()` every 500ms for up to 5 minutes. Backends MAY override this with a more efficient implementation (e.g., server-sent events, WebSocket).
7. `cancel()` is best-effort — the job may have already completed or transitioned to a terminal state.

## 4. Types

### 4.1 Capabilities

Describes what a backend can do.

| Field | Type | Description |
|-------|------|-------------|
| `name` | `String` | Backend name |
| `num_qubits` | `u32` | Number of qubits available |
| `gate_set` | `GateSet` | Supported gates (OpenQASM 3 naming) |
| `topology` | `Topology` | Qubit connectivity graph |
| `max_shots` | `u32` | Maximum shots per job |
| `is_simulator` | `bool` | Whether this is a simulator |
| `features` | `Vec<String>` | Additional features (e.g., `"statevector"`, `"dynamic_circuits"`) |
| `noise_profile` | `Option<NoiseProfile>` | Device-wide noise averages |

### 4.2 GateSet

| Field | Type | Description |
|-------|------|-------------|
| `single_qubit` | `Vec<String>` | Supported single-qubit gates |
| `two_qubit` | `Vec<String>` | Supported two-qubit gates |
| `three_qubit` | `Vec<String>` | Supported three-qubit gates |
| `native` | `Vec<String>` | Native gates (empty = all supported are native) |

Gate names follow OpenQASM 3 convention: `h`, `cx`, `rz`, `prx`, `ecr`, etc.

### 4.3 Topology

| Field | Type | Description |
|-------|------|-------------|
| `kind` | `TopologyKind` | Topology class |
| `edges` | `Vec<(u32, u32)>` | Coupling edges (bidirectional) |

All edges are bidirectional: if `(a, b)` is present, both `a → b` and `b → a` are valid two-qubit interactions.

**TopologyKind variants:** `FullyConnected`, `Linear`, `Star`, `Grid { rows, cols }`, `HeavyHex`, `Custom`, `NeutralAtom { zones }`.

### 4.4 NoiseProfile

Device-wide noise averages. All fidelity values in `[0.0, 1.0]` (1.0 = perfect). Time values in microseconds.

| Field | Type | Description |
|-------|------|-------------|
| `t1` | `Option<f64>` | T1 relaxation time (μs) |
| `t2` | `Option<f64>` | T2 dephasing time (μs) |
| `single_qubit_fidelity` | `Option<f64>` | Average 1Q gate fidelity |
| `two_qubit_fidelity` | `Option<f64>` | Average 2Q gate fidelity |
| `readout_fidelity` | `Option<f64>` | Average readout fidelity |
| `gate_time` | `Option<f64>` | Average gate execution time (μs) |

### 4.5 BackendAvailability

| Field | Type | Description |
|-------|------|-------------|
| `is_available` | `bool` | Currently accepting jobs |
| `queue_depth` | `Option<u32>` | Jobs in queue |
| `estimated_wait_secs` | `Option<f64>` | Estimated wait time (seconds) |
| `status_message` | `Option<String>` | Human-readable status |

### 4.6 ValidationResult

Three-state enum:

| Variant | Description |
|---------|-------------|
| `Valid` | Circuit can be submitted as-is |
| `Invalid { reasons }` | Circuit cannot run on this backend |
| `RequiresTranspilation { details }` | Circuit needs compilation but could run after transpilation |

## 5. Job State Machine

```text
  submit() ──→ Queued ──→ Running ──→ Completed
                 │           │
                 │           ├──→ Failed(reason)
                 │           │
                 └───────────┴──→ Cancelled
```

### 5.1 JobStatus

| Variant | Terminal | Description |
|---------|----------|-------------|
| `Queued` | no | Job is waiting in queue |
| `Running` | no | Job is currently executing |
| `Completed` | yes | Job finished successfully |
| `Failed(String)` | yes | Job failed with error message |
| `Cancelled` | yes | Job was cancelled |

**Invariants:**
- `submit()` MUST return `Queued`.
- Transitions are monotonic — a job never moves backward.
- Terminal states are permanent.

### 5.2 JobId

Opaque string identifier. Backends generate these; consumers treat them as opaque.

## 6. Execution Results

### 6.1 ExecutionResult

| Field | Type | Description |
|-------|------|-------------|
| `counts` | `Counts` | Measurement counts |
| `shots` | `u32` | Number of shots executed |
| `execution_time_ms` | `Option<u64>` | Execution time in milliseconds |
| `metadata` | `Value` | Additional backend-specific metadata (JSON) |

### 6.2 Counts

Maps bitstrings to occurrence counts. Bitstring ordering follows the OpenQASM 3 convention: the rightmost bit corresponds to the lowest-indexed qubit.

Example: `"01"` means qubit 0 measured `1`, qubit 1 measured `0`.

## 7. Error Taxonomy

| Category | Variants | Recovery |
|----------|----------|----------|
| **Transient** | `BackendUnavailable`, `Timeout` | Retry with backoff |
| **Permanent** | `InvalidCircuit`, `CircuitTooLarge`, `InvalidShots`, `Unsupported` | Fix input |
| **Job-level** | `SubmissionFailed`, `JobFailed`, `JobCancelled`, `JobNotFound` | Resubmit or abort |
| **Auth** | `AuthenticationFailed` | Re-authenticate |
| **Config** | `Configuration`, `Backend` | Fix configuration |

All 13 variants are `#[non_exhaustive]` — implementations may extend with additional variants in future minor versions.

## 8. Reference Gate Sets

The spec includes reference gate sets for common hardware vendors:

| Vendor | Method | Native Gates |
|--------|--------|-------------|
| IQM | `GateSet::iqm()` | prx, cz |
| IBM Eagle (127q) | `GateSet::ibm_eagle()` | rz, sx, x, ecr |
| IBM Heron (156q) | `GateSet::ibm_heron()` | rz, sx, x, cz, id, rx, h, rzz |
| Rigetti | `GateSet::rigetti()` | rx, rz, cz |
| IonQ | `GateSet::ionq()` | rx, ry, rz, xx |
| Neutral Atom | `GateSet::neutral_atom()` | rz, rx, ry, cz |
| Simulator | `GateSet::universal()` | All standard gates |

## 9. Versioning

The HAL Contract follows semantic versioning:
- **Major version** (v2): Breaking changes to the trait or types.
- **Minor version**: Additive changes (new fields with defaults, new `TopologyKind` variants).
- **Patch version**: Documentation or reference data updates.

## 10. License

Apache License 2.0. See [LICENSE](../LICENSE).
